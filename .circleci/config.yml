version: 2.1
orbs:
  node: circleci/node@4.1.0
  aws-cli: circleci/aws-cli@1.3.1
jobs:
  build:
    docker:
      - image: "cimg/node:20.19-browsers"
    steps:
      - checkout
      - aws-cli/setup:
          aws-access-key-id: AWS_ACCESS_KEY_ID
          aws-secret-access-key: AWS_SECRET_ACCESS_KEY
          aws-region: AWS_DEFAULT_REGION
      - run:
          name: Install EB CLI
          command: |
            sudo apt-get update
            sudo apt-get install -y python3-pip python3-dev build-essential
            pip3 install awsebcli --upgrade --user --break-system-packages
            echo 'export PATH=$HOME/.local/bin:$PATH' >> $BASH_ENV
            source $BASH_ENV
      - run:
          name: Front-End Install
          command: |
            npm run frontend:install
      - run:
          name: Back-End Install
          command: |
            cd ./Backend
            npm install --ignore-scripts
      - run:
          name: Front-End Build
          command: |
            npm run frontend:build
      - run:
          name: Back-End Build
          command: |
            npm run backend:build
      - run:
          name: Install Chrome
          command: |
            wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
            sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google.list'
            sudo apt-get update
            sudo apt-get install -y google-chrome-stable
      - run:
          name: Front-End Tests
          command: |
            export CHROME_BIN=/usr/bin/google-chrome-stable
            npm run frontend:test:ci
      - run:
          name: Deploy Back-End App
          command: |
            cd ./Backend
            eb init $EB_APP_NAME --region $AWS_DEFAULT_REGION --platform node.js
            eb use $EB_ENV_NAME
            eb setenv JWT_SECRET=$JWT_SECRET PEPPER=$PEPPER POSTGRES_DB=$POSTGRES_DB POSTGRES_HOST=$POSTGRES_HOST POSTGRES_PASSWORD=$POSTGRES_PASSWORD POSTGRES_PORT=$POSTGRES_PORT POSTGRES_USER=$POSTGRES_USER SALT=$SALT
            eb deploy
      - run:
          name: Deploy Front-End App
          command: |
            npm run frontend:deploy

workflows:
  version: 2
  build-deploy:
    jobs:
      - build:
          filters:
            branches:
              only:
                - master
